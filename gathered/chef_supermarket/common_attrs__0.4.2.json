{
  "name": "common_attrs Chef cookbook",
  "chef_cookbook_name": "common_attrs",
  "revision": "0.4.2",
  "uris": [
    "https://supermarket.chef.io/cookbooks/common_attrs",
    "https://supermarket.chef.io/cookbooks/common_attrs/download",
    "https://supermarket.chef.io/cookbooks/common_attrs/versions/0.4.2",
    "https://supermarket.chef.io/cookbooks/common_attrs/versions/0.4.2/download",
    "https://supermarket.chef.io/api/v1/cookbooks/common_attrs/versions/0.4.2",
    "https://supermarket.chef.io/api/v1/cookbooks/common_attrs",
    "https://supermarket.chef.io/api/v1/cookbooks/common_attrs/versions/0.4.2/download"
  ],
  "labels": [
    "Chef cookbook",
    "Executable/Script/Chef Cookbook",
    "Mode/Executable/Script/Chef Cookbook"
  ],
  "info_url": "https://supermarket.chef.io/cookbooks/common_attrs",
  "package_url": "https://supermarket.chef.io/api/v1/cookbooks/common_attrs/versions/0.4.2/download",
  "deprecated": false,
  "created": "2016-03-13T17:40:49.493Z",
  "updated": "2016-09-06T15:09:42.809Z",
  "description": "Resourced to help manage Chef attributes",
  "maintainer": {
    "name": "serafini",
    "email": "jonathan@serafini.ca"
  },
  "license": "apachev2",
  "chef_foodcritic_failure": true,
  "chef_up_for_adoption": null,
  "rating": null,
  "followers_count": 1,
  "downloads_count": 1395,
  "downloads_count_revision": 29,
  "repository_url": "https://github.com/JonathanSerafini/chef-common_attrs",
  "issues_url": "https://github.com/JonathanSerafini/chef-common_attrs/issues",
  "chef_source_url": "https://github.com/JonathanSerafini/chef-common_attrs",
  "gatherbase_origin": "chef-supermarket",
  "readme_name": "README.md",
  "readme": "# common_attrs cookbook\n\nA cookbook which provides tools (libraries, custom resources) to help manage Attributes during Chef runs. This is especially useful when using PolicyFiles which require a workflow to replace the concept of Environments.\n\n**Be advised** that this cookbook provides you with all of the necessary tools to shoot yourself in the foot ... repeatedly. When making use of any of the Custom Resources contained within, you should be sure to have a workflow in mind.\n\n# Requirements\n\n* Chef **12.7.0** or later.\n\n# Platform\n\nAny\n\n# Custom Resources\n\n### common_environment\n\nA custom resource which is designed to replicate the concept of *Environment* objects in deployments that make use of *PolicyFiles*.\n\nDuring compile time, these resources will load a *data_bag_item* and then apply it's contents to the *node* attributes at a configurable (or auto detected) precedence level.\n\n#### Attributes\n\n###### common_attrs.environments.data_bag\n\nThe *data_bag* from which to fetch environment items which are formatted much like one would a standard *environment* file.\n\n```json\n{\n  \"id\": \"production\",\n  \"default_attributes\": {\n    \"key\": \"value\"\n  },\n  \"override_attributes\": {\n    \"key\": \"value\"\n  }\n}\n```\n\n###### common_attrs.environments.compile_time\n\nA boolean value which provides a default value for the *common_environment* resource and which determines whether the resources should be applied during compile or converge phase.\n\n###### common_attrs.environments.ignore_missing\n\nA boolean value which provides a default value for the *common_environment* resource and which determines whether the resources should throw an exception when a data_bag_item is not found.\n\n###### common_attrs.environments.active.prepend\n\nAn array of data_bag_item names which is used by the *common_attrs::environments* recipe to create *common_environment* resources.\n\nBy default, this array will contain the following entries :\n* env_#{node.environment.sub(/^\\_/,'')} : the current environment or 'default'\n* env_#{node.policy_group} : the policy_group name if defined\n* policy_#{node.policy_name} : the policy_name if defined\n\n###### common_attrs.environments.active.custom\n\nAn array of data_bag_item names which is used by the *common_attrs::environments* recipe to create *common_environment* resources.\n\nBy default, this array is left empty and is provided to allow you to extend without overriding the auto-generated values in *prepend*.\n\n#### Recipe\n\n###### common_attrs::environments\n\nThis recipe will automatically create *common_environment* resources based on the values found in attributes, first for *prepend* and then for *custom*.\n\n#### Resources\n\n###### common_environment\n\nActions\n* apply: Apply the environment to the node\n\nProperties\n* environment: (name attribute) The name of the data_bag_item to load.\n* data_bag: The data_bag to load from. This defaults to *node.common_attrs.environments.data_bag*.\n* precedence: The precedence level to apply to, which may be either environment, role or node.\n* compile_time: Whether to apply the environment during compile or converge time.\n* ignore_missing: Whether to throw an exception if the data_bag_item is missing.\n\n### common_namespace\n\nA custom resource which provides an alternative to the *Environment* pattern where one would provide configurations specific to a given environment within an attribute namespace.\n\nAs an example, the following node attributes provided by cookbooks, PolicyFiles, Environments, Roles or *common_environment*:\n\n```json\n{\n  \"application\": {\n    \"database_host\": \"127.0.0.1\",\n    \"database_port\": 3306,\n    \"num_processes\": 1\n  },\n  \"_production\": {\n    \"application\": {\n      \"database_host\": \"db.myapp.domain.com\",\n      \"num_processes\": 50  \n    }\n  },\n  \"_staging\": {\n    \"application\": {\n      \"database_host\": \"db.myapp.domain.test\",\n      \"num_processes\": 10  \n    }\n  }\n}\n```\n\n#### Attributes\n\n###### common_attrs.namespaces.compile_time\n\nA boolean value which provides a default value for the *common_namespace* resource and which determines whether the resources should be applied during compile or converge phase.\n\n###### common_attrs.namespaces.prefix\n\nA string with which to prefix namespace names when attempting to locate node attributes. The initial idea is that this be a simple character (_ by default), however this could be a word followed by a period which would expand to an entire hash key.\n\n###### common_attrs.namespaces.active.prepend\n\nAn array of namespace names which is used by the *common_attrs::namespace* recipe to create *namespace* resources.\n\nBy default, this array will contain the following entries :\n* env_#{node.environment.sub(/^\\_/,'')} : the current environment or 'default'\n* env_#{node.policy_group} : the policy_group name if defined\n* policy_#{node.policy_name} : the policy_name if defined\n\n###### common_attrs.namespaces.active.custom\n\nAn array of namespace names which is used by the *common_attrs::namespace* recipe to create *namespace* resources.\n\nBy default, this array is left empty and is provided to allow you to extend without overriding the auto-generated values in *prepend*.\n\n#### Recipe\n\n###### common_attrs::namespaces\n\nThis recipe will automatically create *common_namespace* resources based on the values found in attributes, first for prepend and then for custom.\n\n#### Resources\n\n###### common_namespace\n\nActions\n* apply: Apply the namespace to the node\n\nProperties\n* namespace: (name attribute) The name of the namespace to apply.\n* destination: A period separated path to the attribute to apply this namespace to, defaulting to the root level of the node.\n* precedence: The precedence level to apply to, which may be either environment, role or node.\n* prefix: The prefix to apply to the namespace name and which defaults to *common_attrs.namespaces.prefix*\n* compile_time: Whether to apply the namespace during compile or converge time.\n\n### common_secrets\n\nCustom resources which will load a *data_bag_item* containing secrets into the *node.run_state* if it has not already been created. This may then be used by other resources, such as *common_secret* or directly within your recipes.\n\nExample:\n```json\n{\n  \"id\": \"secrets\",\n  \"my_key\": \"my_value\"\n}\n```\n\n```ruby\ncommon_secrets \"secrets\"\nraise node.run_state[:common_secrets][:secrets][:my_key]\n```\n\n```json\n{\n  \"common_secrets\":{\n    \"active\":{\n      \"deploy_keys\": {\n        \"attribute_path\": \"common_auth.users.config.www-data.keys.private_keys.deploy\",\n        \"secrets_item\": \"deploy\"\n      }\n    }\n  }\n}\n```\n\n#### Attributes\n\n###### common_attrs.secrets.data_bag\n\nThe *data_bag* from which to fetch secrets items. The format of the *data_bag_item* is free form.\n\n###### common_attrs.secrets.compile_time\n\nA boolean value which provides a default value for the *common_secrets* resource and which determines whether the resources should be applied during compile or converge phase.\n\n###### common_attrs.secrets.active\n\nA hash of key => hash pairs which are used by the recipes to create instances of common_secrets and where the name refers to the common_secrets name and the hash is any properties to apply.\n\n```json\n{\n  \"action\": {\n    \"secrets\": {\n      \"compile_time\": true,\n      \"secrets_item\": \"data_bag_item_name\"\n    }\n  }\n}\n```\n\n#### Recipes\n\n###### common_attrs:secrets\n\nThis recipe will automatically create *common_secret* resources based on the values found in attributes.\n\n#### Resources\n\n###### common_secrets\n\nActions\n* apply: Apply the secrets to the node run_state\n\nProperties\n* secrets_item: (name attribute) The name of the data_bag_item to load.\n* secrets_bag: The name of the data_bag to load items from.\n* secrets_name: The name of the key under node.run_state[:common_secrets] to load this in.\n* compile_time: Whether to apply the secrets during compile or converge time.\n\n###### common_secret\n\nActions\n* apply: Apply the secret to node attributes\n\nProperties\n* attribute_path: (name attribute) The location where to copy the secret to.\n* secrets_path: The path within the *common_secret* run_state hash where the secret may be found.\n* secrets_item: The name of the data_bag_item to load.\n* secrets_bag: The name of the data_bag to load items from.\n* compile_time: Whether to apply the secret during compile or converge time.\n\n# Additional Recipes / Attributes\n\n### Attributes Obfuscated\n\nHash of key => boolean values where the keys represent a path to an attribute that should be replaced prior to Chef reporting to chef server.\n\n#### Attributes\n\n###### common_attrs.obfuscated\n\n```json\n{\n  \"plain\": {\n    \"text\": {\n      \"secret\": \"value\"\n    }\n  },\n  \"common_attrs\": {\n     \"obfuscated\": {\n      \"plain.text.secret\": true\n    }\n  }\n}\n```\n\n#### Recipes\n\n###### common_attrs::obfuscated\n\nThis recipe creates a *converge_complete* event handler which will go through the hash of obfuscated types and replace their content with `**suppressed sensitive output**`.\n\n### Attributes Blacklisted\n\nHash of key => boolean values where the keys represent a path to an attribute that should be deleted prior to Chef reporting to chef server.\n\n#### Attributes\n\n###### common_attrs.blacklisted\n\n```json\n{\n  \"plain\": {\n    \"text\": {\n      \"secret\": \"value\"\n    }\n  },\n  \"common_attrs\": {\n     \"blacklisted\": {\n      \"plain.text.secret\": true\n    }\n  }\n}\n```\n\n#### Recipes\n\n###### common_attrs::blacklisted\n\nThis recipe creates a *converge_complete* event handler which will go through the hash of obfuscated types and deletes their content.\n\n# Library Methods\n\nThis cookbook provides a number of helper methods and injects a few of them by monkey patching DataBagItem, Node::Attributes and Resource. When doing this, special care is taken to ensure that the method names are namespaced so as to minimize future WTF moments.\n\nDocumentation on each of these may be found within the library files.\n\n- Hash.dig\n- Hash.common_assign_at\n- Resource.common_properties\n- DataBagItem.to_common_data\n- DataBagItem.to_common_namespace\n- EncryptedDataBagItem.to_common_data\n- EncryptedDataBagItem.to_common_namespace\n- Attribute.to_common_data\n- Attribute.to_common_namespace\n- Common::Delegator::ObfuscatedType\n\n# Attribute Precedence\n\nGiven that we're dealing with Attributes, special care needs to be taken to ensure that we don't get lost in the myriad of different precedence levels.\n\nThe table below contains a listing of where the new custom resources fit within this precedence from least important to most.\n\n|new?|source|precedence level|\n|---|---|---|\n|no|cookbook.attribute|default|\n|no|cookbook.recipe|default|\n|no|environment|environment_default|\n|yes|common_environment|environment_default|\n|yes|common_namespace|environment_default|\n|no|role|role_default|\n|no|policy_file|role_default|\n|yes|common_secrets|force_default|\n|no|cookbook.attribute|normal|\n|no|cookbook.recipe|normal|\n"
}